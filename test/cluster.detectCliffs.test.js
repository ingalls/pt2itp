'use strict';

const Cluster = require('../lib/map/cluster');
const test = require('tape');

const buildDistDelta = (cluster) => cluster.addressPoints.reduce((m, v, i, a) => {
    if (i > 0) {
        const deltaNum = a[i].props.number - a[i - 1].props.number;
        m.push([a[i].location, deltaNum > 0 ? 1 : -1]);
    }
    return m;
}, []);

test('Assert no cliffs: decreasing address', (t) => {
    const breaks = [];
    const dist = [{}, {}, {}, {}, {}, {}, {}];
    const distDelta = [
        [0.08377450659387839, -1],
        [0.17396332414573248, -1],
        [0.23793824079317832, -1],
        [0.3891094963970436, -1],
        [0.44205524435250465, -1],
        [0.5580128085166958, -1],
        [0.6847299289068616, -1]
    ];

    Cluster.detectPeaks(breaks, dist, distDelta);

    t.deepEquals(breaks, []);

    t.end();
});

test('Assert single cliff detection', (t) => {
    const breaks = [];

    const dist = [
        { props: { number: 6 } },
        { props: { number: 5 } },
        { props: { number: 4 } },
        { props: { number: 3 } },
        { props: { number: 2 } },
        { props: { number: 1 } },
        { props: { number: 8 } },
        { props: { number: 7 } },
        { props: { number: 6 } },
        { props: { number: 5 } },
        { props: { number: 4 } },
        { props: { number: 3 } },
        { props: { number: 2 } }
    ];

    const distDelta = [
        [0.2889308532059473, -1],
        [0.3891094963970436, -1],
        [0.44205524435250465, -1],
        [0.5580128085166958, -1],
        [0.6847299289068616, -1],
        [1.6431225457560013, 1],
        [1.8805725020521158, -1],
        [1.8826690187380661, -1],
        [2.0578276385130447, -1],
        [2.135383249826695, -1],
        [2.293316256609901, -1],
        [2.3579600324821057, -1]
    ];

    Cluster.detectCliffs(breaks, dist, distDelta);

    t.deepEquals(breaks, [5]);

    t.end();
});


test('Assert multiple cliffs detection', (t) => {
    const breaks = [];

    const dist = [
        { props: { number: 8 } },
        { props: { number: 7 } },
        { props: { number: 6 } },
        { props: { number: 5 } },
        { props: { number: 4 } },
        { props: { number: 3 } },
        { props: { number: 2 } },
        { props: { number: 1 } },
        { props: { number: 8 } },
        { props: { number: 7 } },
        { props: { number: 6 } },
        { props: { number: 5 } },
        { props: { number: 4 } },
        { props: { number: 3 } },
        { props: { number: 2 } },
        { props: { number: 1 } },
        { props: { number: 8 } },
        { props: { number: 7 } },
        { props: { number: 6 } },
        { props: { number: 5 } },
        { props: { number: 4 } }
    ];

    const distDelta = [
        [0.08377450659387839, -1],
        [0.17396332414573248, -1],
        [0.23793824079317832, -1],
        [0.3891094963970436, -1],
        [0.44205524435250465, -1],
        [0.5580128085166958, -1],
        [0.6847299289068616, -1],
        [1.6431225457560013, 1],
        [1.8805725020521158, -1],
        [1.8826690187380661, -1],
        [2.0578276385130447, -1],
        [2.135383249826695, -1],
        [2.293316256609901, -1],
        [2.3579600324821057, -1],
        [2.4359468967236415, -1],
        [2.5122786060672806, 1],
        [2.5122786060672806, -1],
        [2.5122786060672806, -1],
        [2.5122786060672806, -1],
        [2.5122786060672806, -1]
    ];

    Cluster.detectCliffs(breaks, dist, distDelta);

    t.deepEquals(breaks, [7, 15]);

    t.end();
});


// cliff detection

//             *                      *
//                 *                 *
//                     *            *
//
//         *
//     *                *
// *                         *
//       *                       *
//    *                               *
// *
// TODO: this generates a lot of bad clusters. need to be conservative about splitting with chaotic data
test.skip('handle multiple overlapping housing developments on single road', (t) => {
    const cluster = {
        addressPoints: [
            { location: 0.22106693775503267, props: { number: '13' } },
            { location: 0.21577396485284156, props: { number: '14' } },
            { location: 0.2111902553832963, props: { number: '15' } },
            { location: 0.20535397304438702, props: { number: '16' } },
            { location: 0.20140092040272992, props: { number: '17' } },
            { location: 0.19653514798087343, props: { number: '18' } },
            { location: 0.18949727636222788, props: { number: '19' } },
            { location: 0.18381520055112224, props: { number: '20' } },
            { location: 0.18023469695418773, props: { number: '21' } },
            { location: 0.1706611193160421, props: { number: '22' } },
            { location: 0.16665343244276126, props: { number: '23' } },
            { location: 0.15421663643771588, props: { number: '24' } },
            { location: 0.14149029955677023, props: { number: '25' } },
            { location: 0.018951814573157193, props: { number: '26' } },
            { location: 0.02212282621638896, props: { number: '27' } },
            { location: 0.023021517901666698, props: { number: '28' } },
            { location: 0.02770659900943017, props: { number: '29' } },
            { location: 0.029333742251787635, props: { number: '30' } },
            { location: 0.03159420408476801, props: { number: '31' } },
            { location: 0.03346833265035837, props: { number: '32' } },
            { location: 0.03844353003713687, props: { number: '33' } },
            { location: 0.04030220429239518, props: { number: '34' } },
            { location: 0.043158108410343385, props: { number: '35' } },
            { location: 0.04473991478151326, props: { number: '36' } },
            { location: 0, props: { number: '37' } },
            { location: 0, props: { number: '38' } },
            { location: 0.0049638670038710175, props: { number: '39' } },
            { location: 0.008997225300832405, props: { number: '40' } },
            { location: 0.016182646467158664, props: { number: '41' } },
            { location: 0.021022279926153607, props: { number: '42' } },
            { location: 0.026723211727095082, props: { number: '43' } },
            { location: 0.031310314524523306, props: { number: '44' } },
            { location: 0.03788379458103334, props: { number: '45' } },
            { location: 0.04256474944871931, props: { number: '46' } },
            { location: 0.049529296956733714, props: { number: '47' } },
            { location: 0.055960425903508935, props: { number: '48' } },
            { location: 0.08389250226475663, props: { number: '49' } },
            { location: 0.08600214676983353, props: { number: '50' } },
            { location: 0.08600214676983353, props: { number: '51' } },
            { location: 0.08715023096911635, props: { number: '52' } },
            { location: 0.09341153527762479, props: { number: '53' } },
            { location: 0.0973982619183992, props: { number: '54' } },
            { location: 0.10196991287205874, props: { number: '55' } },
            { location: 0.10721632707253637, props: { number: '56' } },
            { location: 0.11332645776847286, props: { number: '57' } },
            { location: 0.1173853270373999, props: { number: '58' } },
            { location: 0.12335526094956903, props: { number: '59' } },
            { location: 0.12852883344393878, props: { number: '60' } },
            { location: 0.1337838873714499, props: { number: '61' } },
            { location: 0.12818270694915543, props: { number: '62' } },
            { location: 0.12247309198862158, props: { number: '63' } },
            { location: 0.11765737863650251, props: { number: '64' } },
            { location: 0.11129763214619162, props: { number: '65' } },
            { location: 0.10672684950351524, props: { number: '66' } },
            { location: 0.10099558778055284, props: { number: '67' } },
            { location: 0.09949845027598352, props: { number: '68' } },
            { location: 0.09377447953847375, props: { number: '69' } },
            { location: 0.08925177341867278, props: { number: '70' } },
            { location: 0.08600214676983353, props: { number: '71' } },
            { location: 0.08600214676983353, props: { number: '72' } },
            { location: 0.19511184867541115, props: { number: '73' } },
            { location: 0.19160994613115143, props: { number: '74' } },
            { location: 0.18402644699061046, props: { number: '75' } },
            { location: 0.18091298442088516, props: { number: '76' } },
            { location: 0.17664650195576898, props: { number: '77' } },
            { location: 0.17273116795941193, props: { number: '78' } },
            { location: 0.16614280338419854, props: { number: '79' } },
            { location: 0.16311328986583812, props: { number: '80' } },
            { location: 0.16130240412633115, props: { number: '81' } },
            { location: 0.1571336059906931, props: { number: '82' } },
            { location: 0.15102389844351105, props: { number: '83' } },
            { location: 0.14884136570113096, props: { number: '84' } },
            { location: 0.36846501965636125, props: { number: '85' } },
            { location: 0.36874395255516856, props: { number: '86' } },
            { location: 0.3689626494397329, props: { number: '87' } },
            { location: 0.36846501965636125, props: { number: '88' } },
            { location: 0.3704657160233362, props: { number: '89' } },
            { location: 0.37144010574510217, props: { number: '90' } },
            { location: 0.37158409495266664, props: { number: '91' } },
            { location: 0.3729054529735841, props: { number: '92' } },
            { location: 0.3741034525790438, props: { number: '93' } },
            { location: 0.3744410188823591, props: { number: '94' } },
            { location: 0.3749968204907346, props: { number: '95' } },
            { location: 0.37532899824277716, props: { number: '96' } }
        ]
    };

    cluster.addressPoints.sort((a, b) => a.location - b.location);

    const distDelta = buildDistDelta(cluster);

    const breaks = [];

    Cluster.detectCliffs(breaks, cluster.addressPoints, distDelta);

    t.deepEquals(breaks, []);
    t.end();
});

// *
//      *
//           *
//            *
//             *             *
//              *   *           *
//                     *           *
//                       *            *
// TODO: doesn't split with current implementation, but should
test('handle multiple cliffs', (t) => {
    const cluster = {
        addressPoints: [
            { location: 16.792756816198086, props: { number: '1' } },
            { location: 16.74227136664823, props: { number: '3' } },
            { location: 16.70709856633308, props: { number: '5' } },
            { location: 16.674561447244166, props: { number: '9' } },
            { location: 16.639093185821338, props: { number: '15' } },
            { location: 16.63103000442098, props: { number: '17' } },
            { location: 18.873133493595187, props: { number: '20' } },
            { location: 16.609744506722166, props: { number: '40' } },
            { location: 16.554802272715996, props: { number: '45' } },
            { location: 16.609634851448718, props: { number: '45' } },
            { location: 16.604179555306686, props: { number: '45' } },
            { location: 18.724496232983174, props: { number: '50' } },
            { location: 16.32030714913723, props: { number: '53' } },
            { location: 16.307570866667778, props: { number: '60' } },
            { location: 15.698062447631626, props: { number: '169' } },
            { location: 15.547568309516544, props: { number: '175' } },
            { location: 18.171466029508856, props: { number: '240' } },
            { location: 15.052478106750243, props: { number: '250' } },
            { location: 15.003478890290758, props: { number: '260' } },
            { location: 18.13618734216467, props: { number: '262' } },
            { location: 18.0965976688747, props: { number: '288' } },
            { location: 14.871454508196598, props: { number: '301' } },
            { location: 14.520248816017716, props: { number: '310' } },
            { location: 14.543147150458198, props: { number: '310b' } },
            { location: 14.584777549986635, props: { number: '310' } },
            { location: 14.30935263169258, props: { number: '321' } },
            { location: 14.329816126537443, props: { number: '330' } },
            { location: 14.219073931600693, props: { number: '331' } },
            { location: 14.227080675831104, props: { number: '331' } },
            { location: 14.221788368933092, props: { number: '331b' } },
            { location: 14.226832677820234, props: { number: '331a' } },
            { location: 14.242915076838635, props: { number: '332a' } },
            { location: 14.132156224786307, props: { number: '332' } },
            { location: 14.21068092783028, props: { number: '339' } },
            { location: 14.156363019054618, props: { number: '339c' } },
            { location: 14.159374345321869, props: { number: '339d' } },
            { location: 14.210797320077353, props: { number: '339a' } },
            { location: 14.215075630678765, props: { number: '339b' } },
            { location: 14.253788401640227, props: { number: '339e' } },
            { location: 14.258443671472092, props: { number: '339f' } },
            { location: 14.290454991790805, props: { number: '339' } },
            { location: 14.045285398105728, props: { number: '350' } },
            { location: 14.000984812655515, props: { number: '354' } },
            { location: 13.935193833494075, props: { number: '370' } },
            { location: 13.928244897643799, props: { number: '372' } },
            { location: 13.90539487587875, props: { number: '374' } },
            { location: 13.878474162752912, props: { number: '378' } },
            { location: 17.785102119874175, props: { number: '384' } },
            { location: 13.850373482113332, props: { number: '386' } },
            { location: 13.835549580741038, props: { number: '387' } },
            { location: 13.67191523187443, props: { number: '400' } },
            { location: 17.731970164162266, props: { number: '400' } },
            { location: 17.70358831709906, props: { number: '411' } },
            { location: 13.556535271995086, props: { number: '426' } },
            { location: 17.650230902837002, props: { number: '426' } },
            { location: 17.601201514948116, props: { number: '440' } },
            { location: 13.328936117566128, props: { number: '445b' } },
            { location: 17.558510159162438, props: { number: '454' } },
            { location: 13.309606560068385, props: { number: '455' } },
            { location: 13.188868037237604, props: { number: '471' } },
            { location: 13.062302135717221, props: { number: '480' } },
            { location: 13.087706996383911, props: { number: '480' } },
            { location: 13.058695426809328, props: { number: '480' } },
            { location: 13.013859276843013, props: { number: '480' } },
            { location: 13.052919154171699, props: { number: '480' } },
            { location: 13.079017002992975, props: { number: '480' } },
            { location: 13.007773071007149, props: { number: '480' } },
            { location: 13.114078060354807, props: { number: '480' } },
            { location: 13.049077273799158, props: { number: '480' } },
            { location: 13.005026293278899, props: { number: '480' } },
            { location: 13.07995831801583, props: { number: '480' } },
            { location: 13.107455537984178, props: { number: '480' } },
            { location: 13.078760676688061, props: { number: '480' } },
            { location: 13.003055876518577, props: { number: '480' } },
            { location: 13.046902264717211, props: { number: '480' } },
            { location: 13.078506697583856, props: { number: '480' } },
            { location: 13.039496818175724, props: { number: '480' } },
            { location: 13.077539853617827, props: { number: '480' } },
            { location: 12.99911868209744, props: { number: '480' } },
            { location: 13.106922213435244, props: { number: '480' } },
            { location: 13.044252674422047, props: { number: '480' } },
            { location: 13.079868579128572, props: { number: '480' } },
            { location: 12.99766088052457, props: { number: '480' } },
            { location: 13.034322798442973, props: { number: '480' } },
            { location: 13.107689768072076, props: { number: '480' } },
            { location: 12.995295824397333, props: { number: '480' } },
            { location: 13.079113237275628, props: { number: '480' } },
            { location: 13.107850270948804, props: { number: '480' } },
            { location: 12.996611142130618, props: { number: '480' } },
            { location: 13.033609655961575, props: { number: '480' } },
            { location: 13.030905800294402, props: { number: '480' } },
            { location: 13.103418471247853, props: { number: '480' } },
            { location: 12.999382878314677, props: { number: '480' } },
            { location: 13.031282379897515, props: { number: '480' } },
            { location: 12.997614679090168, props: { number: '480' } },
            { location: 13.09828352520786, props: { number: '480' } },
            { location: 13.031662440098717, props: { number: '480' } },
            { location: 12.997429511879792, props: { number: '480' } },
            { location: 13.099694184051456, props: { number: '480' } },
            { location: 12.994381517116139, props: { number: '480' } },
            { location: 13.03543663745716, props: { number: '480' } },
            { location: 13.099901982165354, props: { number: '480' } },
            { location: 13.032178142371556, props: { number: '480' } },
            { location: 12.9978822869399, props: { number: '480' } },
            { location: 13.099404156577775, props: { number: '480' } },
            { location: 12.998489829842567, props: { number: '480' } },
            { location: 13.026517791439579, props: { number: '480' } },
            { location: 13.098177262683166, props: { number: '480' } },
            { location: 13.040398742258368, props: { number: '480' } },
            { location: 13.09718197956051, props: { number: '480' } },
            { location: 13.001042320984784, props: { number: '480' } },
            { location: 13.056458111743481, props: { number: '480' } },
            { location: 13.069011885095827, props: { number: '480' } },
            { location: 13.034681267579106, props: { number: '480' } },
            { location: 13.001190097770275, props: { number: '480' } },
            { location: 13.059061666819563, props: { number: '480' } },
            { location: 13.00254460397287, props: { number: '480' } },
            { location: 12.999642128167828, props: { number: '480' } },
            { location: 13.036085748483092, props: { number: '480' } },
            { location: 12.970945886059905, props: { number: '497' } },
            { location: 17.399484756794127, props: { number: '504' } },
            { location: 12.857177290552647, props: { number: '513' } },
            { location: 17.36228461837933, props: { number: '516' } },
            { location: 12.809982022851127, props: { number: '525' } },
            { location: 12.733390789222135, props: { number: '531' } },
            { location: 12.722728431268354, props: { number: '535' } },
            { location: 12.634908199258042, props: { number: '545' } },
            { location: 17.298900947051322, props: { number: '550' } },
            { location: 12.578389973040684, props: { number: '560' } },
            { location: 12.507769421885069, props: { number: '561' } },
            { location: 12.555940414921105, props: { number: '561' } },
            { location: 12.446244310943728, props: { number: '564' } },
            { location: 12.421879543344321, props: { number: '567' } },
            { location: 12.484023674361257, props: { number: '567' } },
            { location: 12.393323337839682, props: { number: '567' } },
            { location: 12.353450613335113, props: { number: '568' } },
            { location: 12.37506769120233, props: { number: '568b' } },
            { location: 12.451785186725472, props: { number: '568' } },
            { location: 17.161262533278144, props: { number: '582' } },
            { location: 12.313263051119717, props: { number: '586b' } },
            { location: 12.331010462708862, props: { number: '586' } },
            { location: 12.268871571596135, props: { number: '590' } },
            { location: 12.24525689499555, props: { number: '592' } },
            { location: 17.118682984236518, props: { number: '596' } },
            { location: 12.140238179715949, props: { number: '602' } },
            { location: 12.079701437933013, props: { number: '610a' } },
            { location: 12.052329497325, props: { number: '610' } },
            { location: 17.070641745434088, props: { number: '610' } },
            { location: 12.012735273414181, props: { number: '619' } },
            { location: 11.97633501376058, props: { number: '628' } },
            { location: 11.953744536038421, props: { number: '629' } },
            { location: 11.952584658314123, props: { number: '630' } },
            { location: 17.011991882016776, props: { number: '630' } },
            { location: 11.918396923341026, props: { number: '634' } },
            { location: 11.92970325229979, props: { number: '635' } },
            { location: 11.890938490865256, props: { number: '639' } },
            { location: 11.870610276037095, props: { number: '639c' } },
            { location: 11.87752238406796, props: { number: '639b' } },
            { location: 11.883415365692727, props: { number: '639' } },
            { location: 11.863739197296137, props: { number: '642' } },
            { location: 16.972339081101943, props: { number: '650' } },
            { location: 16.961864778859482, props: { number: '652' } },
            { location: 11.748058635801, props: { number: '659' } },
            { location: 11.618729929359901, props: { number: '670' } },
            { location: 16.920010722824866, props: { number: '670' } },
            { location: 16.91175561296331, props: { number: '672' } },
            { location: 11.61409764525365, props: { number: '679' } },
            { location: 16.869954828623104, props: { number: '680' } },
            { location: 16.85796273762758, props: { number: '682' } },
            { location: 11.541772369332007, props: { number: '685' } },
            { location: 11.493541844291313, props: { number: '693' } },
            { location: 11.378929851452824, props: { number: '699' } },
            { location: 11.341629343552357, props: { number: '705' } },
            { location: 11.328471775083951, props: { number: '708' } },
            { location: 11.32184710998875, props: { number: '710' } },
            { location: 11.285126077879534, props: { number: '715' } },
            { location: 11.27409284351127, props: { number: '716' } },
            { location: 11.273973283708214, props: { number: '716' } },
            { location: 16.76708310200925, props: { number: '716' } },
            { location: 11.243271761641363, props: { number: '725' } },
            { location: 16.700075322856918, props: { number: '730' } },
            { location: 11.150424653058677, props: { number: '731' } },
            { location: 11.163501016065181, props: { number: '740' } },
            { location: 11.033063995172613, props: { number: '740a' } },
            { location: 11.05861337686643, props: { number: '740' } },
            { location: 11.415222927526717, props: { number: '740b' } },
            { location: 11.095500846947475, props: { number: '741' } },
            { location: 11.061636146645084, props: { number: '750' } },
            { location: 11.028345683772669, props: { number: '751' } },
            { location: 10.871479574429008, props: { number: '765d' } },
            { location: 10.86015730379564, props: { number: '765' } },
            { location: 10.916229121058873, props: { number: '765' } },
            { location: 10.803127842932778, props: { number: '795c' } },
            { location: 10.65321374293457, props: { number: '795' } },
            { location: 10.795108422261805, props: { number: '795b' } },
            { location: 10.770192448122316, props: { number: '795' } },
            { location: 10.665501089215173, props: { number: '804' } },
            { location: 10.637200333440031, props: { number: '806' } },
            { location: 10.54963631107557, props: { number: '815' } },
            { location: 10.487012648925699, props: { number: '1810' } },
            { location: 10.428249607819122, props: { number: '1830' } },
            { location: 10.370484034175533, props: { number: '1850' } },
            { location: 10.253671645290915, props: { number: '1860' } },
            { location: 10.294063451409922, props: { number: '1860a' } },
            { location: 10.276474072290402, props: { number: '1860b' } },
            { location: 10.284181619935937, props: { number: '1860' } },
            { location: 10.3245485288699, props: { number: '1860c' } },
            { location: 10.2973539494132, props: { number: '1860' } },
            { location: 10.349450775741163, props: { number: '1860' } },
            { location: 10.293098037096405, props: { number: '1874' } },
            { location: 10.25753092810196, props: { number: '1886' } },
            { location: 10.183843761456489, props: { number: '1910' } },
            { location: 10.171915428606995, props: { number: '1911' } },
            { location: 10.144873964801166, props: { number: '1922' } },
            { location: 10.085864356638123, props: { number: '1933' } },
            { location: 10.102503126875211, props: { number: '1940' } },
            { location: 10.0581267414693, props: { number: '1956' } },
            { location: 10.005384828924424, props: { number: '1970' } },
            { location: 9.956307240378138, props: { number: '1979' } },
            { location: 9.959950489200443, props: { number: '1982' } },
            { location: 9.91316503570017, props: { number: '1996' } },
            { location: 10.062948714297775, props: { number: '2020' } },
            { location: 9.831676889899972, props: { number: '2024' } },
            { location: 9.720327804002654, props: { number: '2055' } },
            { location: 9.66321998843766, props: { number: '2080' } },
            { location: 9.63009280419034, props: { number: '2081' } },
            { location: 9.611570450384571, props: { number: '2100' } },
            { location: 9.54118308668934, props: { number: '2115' } },
            { location: 9.547790391504527, props: { number: '2120' } },
            { location: 9.48059215832963, props: { number: '2142' } },
            { location: 9.470402121962165, props: { number: '2164' } },
            { location: 9.350940650506224, props: { number: '2181' } },
            { location: 9.383850624933068, props: { number: '2190' } },
            { location: 9.298632518679193, props: { number: '2212' } },
            { location: 9.241518520399815, props: { number: '2224' } },
            { location: 9.14076111288301, props: { number: '2250' } },
            { location: 8.6431662679071, props: { number: '2401' } },
            { location: 8.661226855545172, props: { number: '2401' } },
            { location: 8.341401879395061, props: { number: '2512' } },
            { location: 8.273784715566032, props: { number: '2537' } },
            { location: 8.249061247663853, props: { number: '2544' } },
            { location: 8.237704909610455, props: { number: '2545' } },
            { location: 8.208722704300632, props: { number: '2555' } },
            { location: 7.497538675870154, props: { number: '2713' } },
            { location: 7.550009865345223, props: { number: '2713' } },
            { location: 7.504650622571529, props: { number: '2713c' } },
            { location: 7.6939699899155585, props: { number: '2713d' } },
            { location: 7.707420402594216, props: { number: '2713b' } },
            { location: 7.751307323249779, props: { number: '2713' } },
            { location: 7.7275088297245125, props: { number: '2713' } },
            { location: 7.614669027039279, props: { number: '2743' } },
            { location: 7.62292743036004, props: { number: '2754' } },
            { location: 7.574640746565689, props: { number: '2770' } },
            { location: 7.568501177374744, props: { number: '2775' } },
            { location: 7.517312730604451, props: { number: '2782' } },
            { location: 7.516569056437614, props: { number: '2783' } },
            { location: 7.478125503266129, props: { number: '2800' } },
            { location: 7.470474817871302, props: { number: '2801' } },
            { location: 7.436641529130945, props: { number: '2812' } },
            { location: 7.422730233832092, props: { number: '2813' } },
            { location: 7.39171989800363, props: { number: '2830' } },
            { location: 7.383808620963151, props: { number: '2831' } },
            { location: 7.347419686734711, props: { number: '2840' } },
            { location: 7.334465494835417, props: { number: '2847' } },
            { location: 7.293274616661821, props: { number: '2856' } },
            { location: 7.287069370693464, props: { number: '2857' } },
            { location: 7.324594748650337, props: { number: '2871' } },
            { location: 7.24329614547656, props: { number: '2880' } },
            { location: 7.315722202773596, props: { number: '2891' } },
            { location: 7.21408132882279, props: { number: '2903' } },
            { location: 7.267093857371674, props: { number: '2905a' } },
            { location: 7.059498502797746, props: { number: '2927' } },
            { location: 6.85729486963868, props: { number: '3000' } },
            { location: 6.7808703723174055, props: { number: '3029' } },
            { location: 6.721702012853722, props: { number: '3046' } },
            { location: 6.721127149457357, props: { number: '3047' } },
            { location: 6.731001427478895, props: { number: '3049' } },
            { location: 6.659013241541912, props: { number: '3070' } },
            { location: 6.648334564003969, props: { number: '3071' } },
            { location: 6.5998843434950265, props: { number: '3088' } },
            { location: 6.541090791209285, props: { number: '3100' } },
            { location: 6.386894380196315, props: { number: '3140' } },
            { location: 6.291077754186831, props: { number: '3181' } },
            { location: 6.243064813250779, props: { number: '3191' } },
            { location: 6.1403237901361285, props: { number: '3231' } },
            { location: 6.147661306784294, props: { number: '3232' } },
            { location: 6.1031337599189435, props: { number: '3243' } },
            { location: 6.2145223733990935, props: { number: '3252' } },
            { location: 5.867583797426377, props: { number: '3321' } },
            { location: 5.81759249936073, props: { number: '3351' } },
            { location: 5.653028943713514, props: { number: '3401' } },
            { location: 5.334878533051755, props: { number: '3490' } },
            { location: 5.062826266993203, props: { number: '3492' } },
            { location: 5.311445117584386, props: { number: '3492' } },
            { location: 5.078995764567125, props: { number: '3570' } },
            { location: 4.721577756533089, props: { number: '3670' } },
            { location: 4.704122333600121, props: { number: '3671a' } },
            { location: 4.758371044543167, props: { number: '3671' } },
            { location: 4.838457446881129, props: { number: '3672' } },
            { location: 4.642711383098526, props: { number: '3680' } },
            { location: 4.41081330829284, props: { number: '3684' } },
            { location: 4.437108931419753, props: { number: '3686' } },
            { location: 3.9421069681542558, props: { number: '3720' } },
            { location: 3.858560998911068, props: { number: '3724' } },
            { location: 3.3987480616115957, props: { number: '3730' } },
            { location: 3.4884592586838963, props: { number: '3738' } },
            { location: 3.415155692921364, props: { number: '3753' } },
            { location: 3.4085564757446596, props: { number: '3756' } },
            { location: 3.25914819758486, props: { number: '3757' } },
            { location: 3.3165330981290393, props: { number: '3760' } },
            { location: 3.2215541487191506, props: { number: '3768' } },
            { location: 3.1627368635670186, props: { number: '3772' } },
            { location: 3.127871544800305, props: { number: '3773' } },
            { location: 3.1232271255886817, props: { number: '3774' } },
            { location: 3.093995044873083, props: { number: '3776' } },
            { location: 3.063847114974304, props: { number: '3778' } },
            { location: 3.0333979916751828, props: { number: '3780' } },
            { location: 3.000592361206714, props: { number: '3782' } },
            { location: 2.9682347415850496, props: { number: '3784' } },
            { location: 2.935621061915433, props: { number: '3786' } },
            { location: 2.9042283215742546, props: { number: '3788' } },
            { location: 2.8709531044571968, props: { number: '3790' } },
            { location: 2.8433046825485198, props: { number: '3792' } },
            { location: 2.8097491488325086, props: { number: '3794' } },
            { location: 2.7595486400561318, props: { number: '3798' } },
            { location: 2.7281170880965093, props: { number: '3800' } },
            { location: 2.676784643547076, props: { number: '3802' } },
            { location: 2.636835205670983, props: { number: '3806' } },
            { location: 2.605803384372569, props: { number: '3808' } },
            { location: 2.53377658654046, props: { number: '3811' } },
            { location: 2.470929880094205, props: { number: '3815' } },
            { location: 2.4160400778114663, props: { number: '3819' } },
            { location: 2.360610551416251, props: { number: '3823' } },
            { location: 2.279028305007615, props: { number: '3827' } },
            { location: 2.203029508523359, props: { number: '3833' } },
            { location: 2.129927064649305, props: { number: '3839' } },
            { location: 2.072215328556071, props: { number: '3843' } },
            { location: 1.9986843287463363, props: { number: '3847' } },
            { location: 1.8669048080726067, props: { number: '3853' } },
            { location: 1.9505606937466933, props: { number: '3853' } },
            { location: 1.7860586729520143, props: { number: '3863' } },
            { location: 1.9146761146092222, props: { number: '3867b' } },
            { location: 1.7896714127549722, props: { number: '3867' } },
            { location: 1.62026684941537, props: { number: '3871' } },
            { location: 1.556266429724338, props: { number: '3875' } },
            { location: 1.5016472662245988, props: { number: '3879' } },
            { location: 1.4335962853228545, props: { number: '3883' } },
            { location: 1.3597285051593964, props: { number: '3889' } },
            { location: 1.2538195711599045, props: { number: '3897' } },
            { location: 0.9579621827239234, props: { number: '3917' } },
            { location: 0.4995447175791465, props: { number: '3964' } },
            { location: 0.43093841156705687, props: { number: '3965' } },
            { location: 0.4391346016456474, props: { number: '3968' } },
            { location: 0.4117616863768525, props: { number: '3972' } },
            { location: 0.39026369841218633, props: { number: '3974b' } },
            { location: 0.39331310076360876, props: { number: '3974' } },
            { location: 0.4024960888981378, props: { number: '3974a' } },
            { location: 0.3118455441372908, props: { number: '3980' } },
            { location: 0.16004648644966915, props: { number: '4000' } }
        ]
    };

    cluster.addressPoints.sort((a, b) => a.location - b.location);

    const distDelta = buildDistDelta(cluster);

    const breaks = [];

    Cluster.detectCliffs(breaks, cluster.addressPoints, distDelta);

    t.deepEquals(breaks, []);
    t.end();
});


// *
//    *
//       *
//          *
//             *          *
//                *             *
//                   *                *
//                      *
test('handle cliff', (t) => {
    const cluster = {
        addressPoints: [
            { location: 9.123133109307451, props: { number: '3' } },
            { location: 9.10084409035324, props: { number: '8' } },
            { location: 9.065310441725245, props: { number: '10' } },
            { location: 9.06068973304285, props: { number: '11' } },
            { location: 9.063099694203423, props: { number: '12' } },
            { location: 9.053891682860758, props: { number: '13' } },
            { location: 9.034840779690494, props: { number: '16' } },
            { location: 9.007044249199415, props: { number: '20' } },
            { location: 8.99513778962469, props: { number: '21' } },
            { location: 8.959637559734748, props: { number: '26' } },
            { location: 8.940013205490152, props: { number: '31' } },
            { location: 8.810291931305816, props: { number: '44' } },
            { location: 8.733645927276287, props: { number: '58' } },
            { location: 8.693223562829713, props: { number: '59' } },
            { location: 8.648411734513694, props: { number: '66' } },
            { location: 8.649680419038335, props: { number: '66' } },
            { location: 8.604557934952545, props: { number: '74' } },
            { location: 8.547133491755629, props: { number: '80' } },
            { location: 8.498826879034679, props: { number: '85' } },
            { location: 8.415818029353309, props: { number: '95' } },
            { location: 8.435884971220466, props: { number: '96' } },
            { location: 8.374797468980105, props: { number: '102' } },
            { location: 8.31960487930351, props: { number: '110' } },
            { location: 8.28085368134016, props: { number: '116' } },
            { location: 8.2518742757024, props: { number: '117' } },
            { location: 8.213862394998568, props: { number: '121' } },
            { location: 8.238059775835277, props: { number: '156' } },
            { location: 7.855563515258901, props: { number: '168' } },
            { location: 7.788673555505483, props: { number: '184' } },
            { location: 7.687490875575405, props: { number: '185' } },
            { location: 7.752017677051523, props: { number: '190' } },
            { location: 7.670297612942223, props: { number: '194' } },
            { location: 7.615800282099053, props: { number: '195' } },
            { location: 7.6353711498080745, props: { number: '199' } },
            { location: 7.6152511014712, props: { number: '200' } },
            { location: 7.6316805141356925, props: { number: '201' } },
            { location: 7.586155039102467, props: { number: '204' } },
            { location: 7.575000975253615, props: { number: '207' } },
            { location: 7.553114419369055, props: { number: '210' } },
            { location: 7.535189390687494, props: { number: '212' } },
            { location: 7.479667819850137, props: { number: '219' } },
            { location: 7.446101743827569, props: { number: '222' } },
            { location: 7.403976560337759, props: { number: '225' } },
            { location: 7.387204661789695, props: { number: '228' } },
            { location: 7.376429083013808, props: { number: '229' } },
            { location: 7.330779646843892, props: { number: '235' } },
            { location: 7.310660819001998, props: { number: '238' } },
            { location: 7.308115647255109, props: { number: '240' } },
            { location: 7.301891788911216, props: { number: '240' } },
            { location: 7.287898981017403, props: { number: '242' } },
            { location: 7.290000700011791, props: { number: '244' } },
            { location: 7.279757372821088, props: { number: '245' } },
            { location: 7.207306632026646, props: { number: '252' } },
            { location: 7.186492920751859, props: { number: '253' } },
            { location: 7.158258413813261, props: { number: '258' } },
            { location: 7.105334115948623, props: { number: '265' } },
            { location: 7.100664469981037, props: { number: '268' } },
            { location: 7.026127162424697, props: { number: '274' } },
            { location: 6.98227036719218, props: { number: '276' } },
            { location: 6.958238006711613, props: { number: '281' } },
            { location: 6.895297531900548, props: { number: '291' } },
            { location: 6.938315238667313, props: { number: '296b' } },
            { location: 6.87867549407146, props: { number: '296' } },
            { location: 6.922353597385495, props: { number: '296' } },
            { location: 6.744664758041379, props: { number: '303' } },
            { location: 6.6540346496635445, props: { number: '325' } },
            { location: 14.377206154664579, props: { number: '354' } },
            { location: 14.30311111485237, props: { number: '360' } },
            { location: 14.424707993697494, props: { number: '363' } },
            { location: 14.40340422711056, props: { number: '365' } },
            { location: 6.2785961906112, props: { number: '367' } },
            { location: 14.29881268840749, props: { number: '370' } },
            { location: 14.32343450769506, props: { number: '371' } },
            { location: 14.324699896362022, props: { number: '371' } },
            { location: 14.321441907257642, props: { number: '371' } },
            { location: 14.333479931142321, props: { number: '371' } },
            { location: 14.373140036788993, props: { number: '371' } },
            { location: 14.370260811064181, props: { number: '371' } },
            { location: 14.472779900722529, props: { number: '371' } },
            { location: 14.578761248106359, props: { number: '371' } },
            { location: 14.624274317707178, props: { number: '371' } },
            { location: 14.639605163991133, props: { number: '371' } },
            { location: 14.652138459158865, props: { number: '371' } },
            { location: 6.27890542780852, props: { number: '374' } },
            { location: 14.211546712314187, props: { number: '374' } },
            { location: 14.182002379928576, props: { number: '375' } },
            { location: 14.248280555505424, props: { number: '375' } },
            { location: 14.148960284546286, props: { number: '379' } },
            { location: 6.169230992271836, props: { number: '383' } },
            { location: 14.12078867886865, props: { number: '385' } },
            { location: 6.130934417208183, props: { number: '387' } },
            { location: 6.132001235599514, props: { number: '389' } },
            { location: 6.107490863785042, props: { number: '391' } },
            { location: 14.088407364200144, props: { number: '393' } },
            { location: 13.907706852094998, props: { number: '398' } },
            { location: 6.048721859323784, props: { number: '399' } },
            { location: 6.059702816480263, props: { number: '399' } },
            { location: 13.62431775546926, props: { number: '400k' } },
            { location: 13.64584067644484, props: { number: '400' } },
            { location: 13.64918762417244, props: { number: '400c' } },
            { location: 13.689228506630526, props: { number: '400b' } },
            { location: 13.722932406326795, props: { number: '400' } },
            { location: 6.03481739175304, props: { number: '401' } },
            { location: 13.590832100008114, props: { number: '410' } },
            { location: 5.990614396914818, props: { number: '415' } },
            { location: 5.965764982323847, props: { number: '417' } },
            { location: 13.833187052128588, props: { number: '421' } },
            { location: 13.79692323024649, props: { number: '425' } },
            { location: 13.49786546107752, props: { number: '438' } },
            { location: 13.442187618743613, props: { number: '440' } },
            { location: 13.687368763651373, props: { number: '444' } },
            { location: 13.622793546902436, props: { number: '445' } },
            { location: 13.672051918953912, props: { number: '445' } },
            { location: 13.727438432114448, props: { number: '445' } },
            { location: 13.749474454550525, props: { number: '445' } },
            { location: 13.810424959826724, props: { number: '445' } },
            { location: 13.845540500200087, props: { number: '445' } },
            { location: 13.353846925357244, props: { number: '446' } },
            { location: 13.356391898021995, props: { number: '446' } },
            { location: 5.664738883824147, props: { number: '451' } },
            { location: 13.290248078309112, props: { number: '452' } },
            { location: 5.664955888696604, props: { number: '455' } },
            { location: 13.70341930470745, props: { number: '455' } },
            { location: 13.764478648471774, props: { number: '455' } },
            { location: 5.732922436776288, props: { number: '456' } },
            { location: 13.175707554021082, props: { number: '458' } },
            { location: 13.21554014088455, props: { number: '460' } },
            { location: 5.625886755697585, props: { number: '461' } },
            { location: 5.6188370247962816, props: { number: '464' } },
            { location: 13.101909241422083, props: { number: '466' } },
            { location: 12.966928818266322, props: { number: '468' } },
            { location: 13.499864577396487, props: { number: '471' } },
            { location: 13.42878675310798, props: { number: '473' } },
            { location: 5.487980200449456, props: { number: '479' } },
            { location: 5.464335138936034, props: { number: '486' } },
            { location: 12.897604262700064, props: { number: '492' } },
            { location: 12.836427816910714, props: { number: '494' } },
            { location: 12.85293253711657, props: { number: '494' } },
            { location: 12.890180504181046, props: { number: '494' } },
            { location: 12.83424369745547, props: { number: '496' } },
            { location: 13.019312860257598, props: { number: '509' } },
            { location: 12.989968759472088, props: { number: '511' } },
            { location: 12.961601330601201, props: { number: '513' } },
            { location: 12.604002823530658, props: { number: '514' } },
            { location: 12.930378929339978, props: { number: '515' } },
            { location: 12.568587055125093, props: { number: '516' } },
            { location: 12.887396878330842, props: { number: '517' } },
            { location: 4.478975638285251, props: { number: '519' } },
            { location: 4.60294764983148, props: { number: '519e' } },
            { location: 5.029018338050094, props: { number: '519c' } },
            { location: 5.030128964165611, props: { number: '519' } },
            { location: 5.10911717346951, props: { number: '519' } },
            { location: 12.838034245985767, props: { number: '519' } },
            { location: 12.52168457541745, props: { number: '520' } },
            { location: 12.495584709703863, props: { number: '522' } },
            { location: 12.499618742430807, props: { number: '522' } },
            { location: 12.46588848540892, props: { number: '524' } },
            { location: 12.436380087756998, props: { number: '526' } },
            { location: 12.398135679735658, props: { number: '528' } },
            { location: 5.101989179211323, props: { number: '530' } },
            { location: 12.691200941625798, props: { number: '531' } },
            { location: 12.31605317601519, props: { number: '532' } },
            { location: 12.62141443072124, props: { number: '535' } },
            { location: 12.571693523399576, props: { number: '537' } },
            { location: 12.549887569085548, props: { number: '539' } },
            { location: 12.534399479104984, props: { number: '541' } },
            { location: 12.497676294263428, props: { number: '543' } },
            { location: 12.469321175694182, props: { number: '545' } },
            { location: 12.228919148498363, props: { number: '546b' } },
            { location: 12.230323894292884, props: { number: '546' } },
            { location: 12.195044752852562, props: { number: '548' } },
            { location: 12.160133818450708, props: { number: '550' } },
            { location: 12.352264110731035, props: { number: '551' } },
            { location: 12.301895124252157, props: { number: '555' } },
            { location: 12.255702216360229, props: { number: '559' } },
            { location: 12.214468157188506, props: { number: '561' } },
            { location: 12.012470576249852, props: { number: '562' } },
            { location: 12.17424729483675, props: { number: '563' } },
            { location: 11.955884666750645, props: { number: '564' } },
            { location: 11.919418412221967, props: { number: '566' } },
            { location: 12.147748341418993, props: { number: '567' } },
            { location: 11.875395593113039, props: { number: '568' } },
            { location: 11.798821013821433, props: { number: '570' } },
            { location: 12.019828683284977, props: { number: '571' } },
            { location: 12.004789837225621, props: { number: '573' } },
            { location: 11.766141850527127, props: { number: '576' } },
            { location: 11.716822423935527, props: { number: '578' } },
            { location: 11.726537466160998, props: { number: '578' } },
            { location: 4.732621321856355, props: { number: '581' } },
            { location: 11.611789083025673, props: { number: '582' } },
            { location: 11.541158617580827, props: { number: '584' } },
            { location: 11.516663876843179, props: { number: '586' } },
            { location: 11.503012817217565, props: { number: '588' } },
            { location: 11.49920003716836, props: { number: '590' } },
            { location: 11.476105991455949, props: { number: '592' } },
            { location: 11.72662036991303, props: { number: '595' } },
            { location: 11.763093757490658, props: { number: '595' } },
            { location: 4.629392007182095, props: { number: '596' } },
            { location: 11.442294438589263, props: { number: '596' } },
            { location: 4.492989923805502, props: { number: '600' } },
            { location: 11.38123112227144, props: { number: '600' } },
            { location: 4.53223656798308, props: { number: '601' } },
            { location: 11.352879606012715, props: { number: '604' } },
            { location: 11.661227290006082, props: { number: '605' } },
            { location: 11.321731245904441, props: { number: '606' } },
            { location: 11.682902581159379, props: { number: '607' } },
            { location: 4.377878079587804, props: { number: '608' } },
            { location: 11.631477632226366, props: { number: '609' } },
            { location: 11.254766814898685, props: { number: '610' } },
            { location: 4.414878904353871, props: { number: '612' } },
            { location: 4.481544385401961, props: { number: '615' } },
            { location: 11.605524299925381, props: { number: '615' } },
            { location: 11.588854996345875, props: { number: '615' } },
            { location: 4.456371678702412, props: { number: '617' } },
            { location: 11.106305369386796, props: { number: '618' } },
            { location: 11.163438058416988, props: { number: '618' } },
            { location: 11.183478581092274, props: { number: '618' } },
            { location: 11.592329549894508, props: { number: '619' } },
            { location: 11.082348024996744, props: { number: '620' } },
            { location: 11.065988633804931, props: { number: '622' } },
            { location: 11.540372951102723, props: { number: '623' } },
            { location: 11.03041265714628, props: { number: '624' } },
            { location: 11.529506236019229, props: { number: '627' } },
            { location: 10.968559039962106, props: { number: '630' } },
            { location: 10.953898767864102, props: { number: '632' } },
            { location: 11.470999392039802, props: { number: '633' } },
            { location: 10.934515320761784, props: { number: '634' } },
            { location: 11.456465569428413, props: { number: '635' } },
            { location: 10.885791382318727, props: { number: '636' } },
            { location: 11.442555269259747, props: { number: '637' } },
            { location: 4.2486026973728395, props: { number: '639' } },
            { location: 11.431417850585023, props: { number: '639' } },
            { location: 4.249304141809159, props: { number: '640' } },
            { location: 10.865639393903622, props: { number: '640' } },
            { location: 11.332359275878506, props: { number: '643' } },
            { location: 10.810160814343948, props: { number: '644' } },
            { location: 11.29796312202149, props: { number: '645' } },
            { location: 11.29481465587125, props: { number: '647' } },
            { location: 4.171014311139462, props: { number: '648' } },
            { location: 4.144869696490178, props: { number: '648' } },
            { location: 10.747595230483102, props: { number: '648' } },
            { location: 11.296346916094022, props: { number: '649' } },
            { location: 10.726359581536567, props: { number: '650' } },
            { location: 11.272119015669324, props: { number: '651' } },
            { location: 10.713663179494429, props: { number: '652' } },
            { location: 11.257440607514187, props: { number: '653' } },
            { location: 10.618341225196788, props: { number: '656' } },
            { location: 11.203434015159994, props: { number: '659' } },
            { location: 4.067878911209655, props: { number: '660' } },
            { location: 10.590645524583342, props: { number: '660' } },
            { location: 10.576996956027358, props: { number: '662' } },
            { location: 11.113665574463303, props: { number: '663' } },
            { location: 10.563387465590877, props: { number: '664' } },
            { location: 11.06473055943425, props: { number: '665' } },
            { location: 10.535853909228486, props: { number: '666' } },
            { location: 10.509548201428416, props: { number: '668' } },
            { location: 10.491287919789597, props: { number: '670' } },
            { location: 10.997658933830317, props: { number: '671' } },
            { location: 4.017581666083299, props: { number: '672' } },
            { location: 10.47250346731422, props: { number: '672' } },
            { location: 3.96859786059172, props: { number: '673' } },
            { location: 10.449518783593247, props: { number: '674' } },
            { location: 10.440335343002761, props: { number: '675' } },
            { location: 10.443808749705758, props: { number: '676' } },
            { location: 3.9346785146058667, props: { number: '677' } },
            { location: 10.406616091678377, props: { number: '678' } },
            { location: 10.355769838613908, props: { number: '680' } },
            { location: 10.802912523547072, props: { number: '681' } },
            { location: 10.323168928263092, props: { number: '682' } },
            { location: 10.777482943924031, props: { number: '683' } },
            { location: 10.28918248154091, props: { number: '684' } },
            { location: 10.748239830120887, props: { number: '685' } },
            { location: 10.273497255430058, props: { number: '686' } },
            { location: 3.858398516620661, props: { number: '687' } },
            { location: 10.244048166207136, props: { number: '688' } },
            { location: 3.8019124433895546, props: { number: '689' } },
            { location: 3.763213177550288, props: { number: '692' } },
            { location: 10.364114656987216, props: { number: '705' } },
            { location: 10.325982810719106, props: { number: '707' } },
            { location: 10.225125981458488, props: { number: '711' } },
            { location: 3.7046834521135334, props: { number: '712' } },
            { location: 10.018666574787837, props: { number: '713' } },
            { location: 9.661674987373996, props: { number: '715' } },
            { location: 9.818777932190422, props: { number: '715' } },
            { location: 9.775658215649893, props: { number: '715' } },
            { location: 9.867581320586934, props: { number: '715' } },
            { location: 9.669288249942957, props: { number: '720' } },
            { location: 3.625710043400366, props: { number: '722' } },
            { location: 9.854711736259308, props: { number: '723' } },
            { location: 9.852922689536447, props: { number: '725' } },
            { location: 3.5674250826698235, props: { number: '727' } },
            { location: 3.518995321049098, props: { number: '732' } },
            { location: 9.763132342284559, props: { number: '733' } },
            { location: 9.787087453901709, props: { number: '733' } },
            { location: 3.447407415311037, props: { number: '735' } },
            { location: 9.483538714196259, props: { number: '735' } },
            { location: 9.649067339651225, props: { number: '737' } },
            { location: 9.587816701717195, props: { number: '743' } },
            { location: 3.35323523549779, props: { number: '750' } },
            { location: 3.3737005718753075, props: { number: '750' } },
            { location: 3.4174139377292767, props: { number: '752' } },
            { location: 3.3436347598550413, props: { number: '759' } },
            { location: 3.265128614014341, props: { number: '765' } },
            { location: 3.2054413980002896, props: { number: '773' } },
            { location: 9.171398523202564, props: { number: '777' } },
            { location: 2.966641166667811, props: { number: '809' } },
            { location: 2.919129573067778, props: { number: '812' } },
            { location: 2.861424549996276, props: { number: '815' } },
            { location: 2.7738067513379625, props: { number: '832' } },
            { location: 2.71290647230714, props: { number: '838' } },
            { location: 2.7202094612202643, props: { number: '838b' } },
            { location: 2.723271463207281, props: { number: '838' } },
            { location: 2.7111175321523113, props: { number: '840' } },
            { location: 2.7008355185651043, props: { number: '842' } },
            { location: 2.689895029660791, props: { number: '844' } },
            { location: 2.5916224952158053, props: { number: '856' } },
            { location: 2.651862407530104, props: { number: '857' } },
            { location: 2.5220856597707235, props: { number: '863' } },
            { location: 2.4871880850021153, props: { number: '870' } },
            { location: 2.4569305352164372, props: { number: '873' } },
            { location: 2.4521033057365704, props: { number: '874' } },
            { location: 2.3707656536411172, props: { number: '883' } },
            { location: 2.338521073153319, props: { number: '884' } },
            { location: 2.317288291846237, props: { number: '887' } },
            { location: 2.3064689168973938, props: { number: '894' } },
            { location: 2.2515709809252282, props: { number: '895' } },
            { location: 2.2627663983793807, props: { number: '900' } },
            { location: 2.2253145887374326, props: { number: '904' } },
            { location: 2.1883157715183024, props: { number: '907' } },
            { location: 2.1852383155179997, props: { number: '912' } },
            { location: 2.117660867569236, props: { number: '916' } },
            { location: 2.1440590936078308, props: { number: '917' } },
            { location: 2.0703674912249226, props: { number: '923' } },
            { location: 2.0842974195054773, props: { number: '924' } },
            { location: 2.1120073275977203, props: { number: '926' } },
            { location: 2.0538569544308363, props: { number: '928' } },
            { location: 2.041407300229984, props: { number: '929' } },
            { location: 1.9198435068946056, props: { number: '948' } },
            { location: 1.925400614956146, props: { number: '953' } },
            { location: 1.6851195949842461, props: { number: '963' } },
            { location: 1.731239482308238, props: { number: '963b' } },
            { location: 1.7910137995743478, props: { number: '964' } },
            { location: 1.7854809651421866, props: { number: '965' } },
            { location: 1.7401187806719105, props: { number: '968' } },
            { location: 1.7368358933244128, props: { number: '969' } },
            { location: 1.6963635672288049, props: { number: '976' } },
            { location: 1.5750357702873605, props: { number: '988' } },
            { location: 1.5654548452044348, props: { number: '989' } },
            { location: 1.63969674609971, props: { number: '991' } },
            { location: 1.5629826506069138, props: { number: '993' } },
            { location: 1.480231998317711, props: { number: '1006' } },
            { location: 1.3876434429350504, props: { number: '1011' } },
            { location: 1.3648454440550206, props: { number: '1020' } },
            { location: 1.2490961125833584, props: { number: '1032' } },
            { location: 1.2242119922200756, props: { number: '1038' } },
            { location: 1.1643277045253337, props: { number: '1042' } },
            { location: 1.1837232056364912, props: { number: '1043' } },
            { location: 1.0835602123076349, props: { number: '1047' } },
            { location: 0.968139347883653, props: { number: '1068' } },
            { location: 1.2794489499212736, props: { number: '1075' } },
            { location: 0.7568161161606324, props: { number: '1096' } },
            { location: 0.7248547383278696, props: { number: '1101' } },
            { location: 0.6924778171944108, props: { number: '1105' } },
            { location: 0.7112065689072152, props: { number: '1106' } },
            { location: 0.6656976837650328, props: { number: '1109' } },
            { location: 0.6207327857743141, props: { number: '1116' } },
            { location: 0.5021252023445468, props: { number: '1132' } },
            { location: 0.4946248421872446, props: { number: '1133' } },
            { location: 0.3947197713443009, props: { number: '1136' } },
            { location: 0.4694790113329237, props: { number: '1136' } },
            { location: 0.4467695001997225, props: { number: '1137' } },
            { location: 0.4434607615419708, props: { number: '1138' } },
            { location: 0.4002420982153369, props: { number: '1145' } },
            { location: 0.3483607576137375, props: { number: '1150' } },
            { location: 0.32418461875359134, props: { number: '1151b' } },
            { location: 0.3396545856820056, props: { number: '1151' } },
            { location: 0.3074835923869748, props: { number: '1153' } },
            { location: 0.32234042770021404, props: { number: '1154' } },
            { location: 0.29988049743609047, props: { number: '1155' } },
            { location: 0.28899185334703215, props: { number: '1157' } },
            { location: 0.2799070338459121, props: { number: '1158' } },
            { location: 0.2854219017131938, props: { number: '1159' } },
            { location: 0.2609715893396308, props: { number: '1160' } },
            { location: 0.23905717136638635, props: { number: '1162' } },
            { location: 0.25340627341642896, props: { number: '1163' } },
            { location: 0.2435438302743689, props: { number: '1164' } },
            { location: 0.244853144598926, props: { number: '1167' } },
            { location: 0.19357198957033317, props: { number: '1169' } },
            { location: 0.21675989419113553, props: { number: '1169' } },
            { location: 0.20839732074498057, props: { number: '1170' } },
            { location: 0.14947152409317385, props: { number: '1177' } },
            { location: 0.14455793094505054, props: { number: '1178' } },
            { location: 0.12839505041816363, props: { number: '1179' } },
            { location: 0.11558031700127887, props: { number: '1181' } },
            { location: 0.10995241539767171, props: { number: '1182' } },
            { location: 0.10084375516902111, props: { number: '1184' } },
            { location: 0.09771587402805951, props: { number: '1184b' } },
            { location: 0.09847453851990298, props: { number: '1184a' } },
            { location: 0.09908888452520238, props: { number: '1184' } },
            { location: 0.08596734300764403, props: { number: '1185c' } },
            { location: 0.09088740495599591, props: { number: '1185b' } },
            { location: 0.09570607970981183, props: { number: '1185a' } },
            { location: 0.09446671914980387, props: { number: '1185' } },
            { location: 0.06795374900932695, props: { number: '1187' } },
            { location: 0.07537283889366136, props: { number: '1188' } },
            { location: 0.07145226442286856, props: { number: '1188b' } },
            { location: 0.0800782382821436, props: { number: '1188a' } },
            { location: 0.05261263974273698, props: { number: '1189' } },
            { location: 0.029124294183266147, props: { number: '1191' } },
            { location: 0.028535952274326756, props: { number: '1191b' } },
            { location: 0.040290142239397086, props: { number: '1192' } },
            { location: 0.034740984570515054, props: { number: '1194' } }
        ]
    };

    cluster.addressPoints.sort((a, b) => a.location - b.location);

    const distDelta = buildDistDelta(cluster);

    const breaks = [];

    Cluster.detectCliffs(breaks, cluster.addressPoints, distDelta);

    t.deepEquals(breaks, [226]);
    t.end();
});

//      *
//     *         *
//    *            *
//   *         *     *
//  * o     *          *
// *    *               *
// TODO: splits imperfectly due to overlapping ranges
test('handle multiple cliffs with outliers', (t) => {
    const cluster = {
        addressPoints: [
            { location: 8.715147900720957, props: { number: '1' } },
            { location: 1.3771867722978728, props: { number: '2' } },
            { location: 8.721810801201206, props: { number: '2' } },
            { location: 1.4908800845685417, props: { number: '10' } },
            { location: 8.690663364788607, props: { number: '10' } },
            { location: 8.606093477451484, props: { number: '14' } },
            { location: 8.575398129262632, props: { number: '15' } },
            { location: 1.536304119820169, props: { number: '18' } },
            { location: 0.11718292019034142, props: { number: '31' } },
            { location: 8.529720754830869, props: { number: '44' } },
            { location: 8.439292168667523, props: { number: '46' } },
            { location: 8.395229783973136, props: { number: '50' } },
            { location: 8.29980354293526, props: { number: '56' } },
            { location: 8.18002904537587, props: { number: '70' } },
            { location: 8.131274055895675, props: { number: '74' } },
            { location: 1.883889323203329, props: { number: '75' } },
            { location: 1.9866222451970352, props: { number: '80' } },
            { location: 2.0693916397299237, props: { number: '83' } },
            { location: 0.19453357041735733, props: { number: '85' } },
            { location: 2.1676402364383187, props: { number: '86' } },
            { location: 8.09588979510555, props: { number: '86' } },
            { location: 2.144073790977883, props: { number: '87' } },
            { location: 2.2168352777614944, props: { number: '88' } },
            { location: 2.2751483170790925, props: { number: '89' } },
            { location: 2.2899358744227847, props: { number: '90' } },
            { location: 7.9683660186108005, props: { number: '90' } },
            { location: 2.344853133958861, props: { number: '91' } },
            { location: 2.34530224373492, props: { number: '92' } },
            { location: 2.3899669167126283, props: { number: '93' } },
            { location: 2.4137639309584786, props: { number: '94' } },
            { location: 2.454480050782078, props: { number: '95' } },
            { location: 2.497461045929435, props: { number: '98' } },
            { location: 2.499762853966609, props: { number: '99' } },
            { location: 2.5704117849306183, props: { number: '100' } },
            { location: 7.927287451762634, props: { number: '100' } },
            { location: 2.5646667001082246, props: { number: '103' } },
            { location: 7.877899499468957, props: { number: '104' } },
            { location: 0.2590021548827217, props: { number: '105' } },
            { location: 2.67636203898143, props: { number: '106' } },
            { location: 2.6112080705020095, props: { number: '107' } },
            { location: 7.853614698829267, props: { number: '108' } },
            { location: 7.810171500603774, props: { number: '109' } },
            { location: 2.7163620137254503, props: { number: '110' } },
            { location: 2.6646371173505825, props: { number: '111' } },
            { location: 7.768308942061441, props: { number: '111' } },
            { location: 7.8031188236030475, props: { number: '112' } },
            { location: 2.7570852898088014, props: { number: '113' } },
            { location: 7.711101415920293, props: { number: '113' } },
            { location: 7.726918446881007, props: { number: '113' } },
            { location: 2.759470335633738, props: { number: '114' } },
            { location: 2.820577357195924, props: { number: '115' } },
            { location: 7.7166507139201075, props: { number: '120' } },
            { location: 7.64521210749697, props: { number: '124' } },
            { location: 0.33477571538848944, props: { number: '125' } },
            { location: 7.507849836568651, props: { number: '126' } },
            { location: 7.4660876884201, props: { number: '128' } },
            { location: 7.4226684923708595, props: { number: '130' } },
            { location: 7.3572679951434905, props: { number: '132' } },
            { location: 0.37605959923787213, props: { number: '135' } },
            { location: 0.324885610088878, props: { number: '140' } },
            { location: 7.267373360167906, props: { number: '150' } },
            { location: 0.39831225340517123, props: { number: '170' } },
            { location: 0.4910968504698022, props: { number: '180' } },
            { location: 7.1226888536293345, props: { number: '180' } },
            { location: 7.052224700012823, props: { number: '181' } },
            { location: 7.029143330621709, props: { number: '185' } },
            { location: 6.838808272258537, props: { number: '186' } },
            { location: 0.5337647356074156, props: { number: '190' } },
            { location: 6.98730700604662, props: { number: '191' } },
            { location: 6.96967241597163, props: { number: '193' } },
            { location: 6.906104581014776, props: { number: '195' } },
            { location: 6.852925201978143, props: { number: '203' } },
            { location: 6.800151535654023, props: { number: '209' } },
            { location: 0.5785728079438958, props: { number: '210' } },
            { location: 6.762008452286543, props: { number: '211' } },
            { location: 6.741026120307361, props: { number: '215' } },
            { location: 6.713404778914582, props: { number: '217' } },
            { location: 0.6055765457169209, props: { number: '220' } },
            { location: 6.6553208657725555, props: { number: '221' } },
            { location: 0.658142541472686, props: { number: '235' } },
            { location: 0.6397594568205958, props: { number: '240' } },
            { location: 0.667564939554022, props: { number: '240' } },
            { location: 0.7020237532776819, props: { number: '245' } },
            { location: 6.420847154694912, props: { number: '251' } },
            { location: 0.7586352843380014, props: { number: '255' } },
            { location: 0.7395311793418667, props: { number: '264' } },
            { location: 6.357322196957634, props: { number: '264' } },
            { location: 6.308974622568354, props: { number: '268' } },
            { location: 6.217239360005198, props: { number: '274' } },
            { location: 0.8028647357929112, props: { number: '275' } },
            { location: 6.193467577044441, props: { number: '275' } },
            { location: 6.215807837808767, props: { number: '280' } },
            { location: 6.127272081428386, props: { number: '281' } },
            { location: 0.8473181814570472, props: { number: '289' } },
            { location: 6.047967476422096, props: { number: '289' } },
            { location: 6.052967344149741, props: { number: '290' } },
            { location: 0.8648412388402208, props: { number: '300' } },
            { location: 5.987131200566873, props: { number: '300' } },
            { location: 5.941863266636516, props: { number: '301' } },
            { location: 5.9128872822931955, props: { number: '304' } },
            { location: 5.832960576683252, props: { number: '305' } },
            { location: 5.801901841838985, props: { number: '310' } },
            { location: 5.814239162857286, props: { number: '311' } },
            { location: 0.8840675221839389, props: { number: '313' } },
            { location: 5.680550539334872, props: { number: '315' } },
            { location: 5.753059982067954, props: { number: '315' } },
            { location: 5.765439903496534, props: { number: '316' } },
            { location: 0.9051249971324693, props: { number: '318' } },
            { location: 5.545974329111309, props: { number: '331' } },
            { location: 5.511925172486506, props: { number: '332' } },
            { location: 0.9796690042971187, props: { number: '333' } },
            { location: 5.5200333687361125, props: { number: '337' } },
            { location: 5.4039508370023706, props: { number: '343' } },
            { location: 5.329301831946103, props: { number: '346' } },
            { location: 1.0468328303419836, props: { number: '355' } },
            { location: 5.196251725674977, props: { number: '355' } },
            { location: 5.217356399055948, props: { number: '356' } },
            { location: 5.149966699820001, props: { number: '362' } },
            { location: 1.083104372232071, props: { number: '375' } },
            { location: 4.976790148958981, props: { number: '383' } },
            { location: 1.1361699249759343, props: { number: '385' } },
            { location: 1.1884839263282232, props: { number: '395' } },
            { location: 4.649052266863529, props: { number: '403' } },
            { location: 4.668502031792487, props: { number: '406' } },
            { location: 4.57539601423573, props: { number: '416' } },
            { location: 1.211346698518042, props: { number: '420' } },
            { location: 1.239115691048625, props: { number: '421' } },
            { location: 4.509145361427464, props: { number: '421' } },
            { location: 4.496175845892966, props: { number: '425' } },
            { location: 4.4430274912583245, props: { number: '426' } },
            { location: 4.415127163695609, props: { number: '431' } },
            { location: 4.387086846233455, props: { number: '432' } },
            { location: 1.2893371206560207, props: { number: '435' } },
            { location: 4.325350331358861, props: { number: '437' } },
            { location: 4.343304719856502, props: { number: '438' } },
            { location: 4.288420113354554, props: { number: '443' } },
            { location: 4.315061506323116, props: { number: '444' } },
            { location: 1.3224775026587496, props: { number: '445' } },
            { location: 4.082341411381874, props: { number: '449' } },
            { location: 4.082341411381874, props: { number: '455' } },
            { location: 4.088553001509162, props: { number: '459' } },
            { location: 4.071663868662381, props: { number: '460' } },
            { location: 4.013179960361144, props: { number: '467' } },
            { location: 3.660015155146376, props: { number: '480' } },
            { location: 3.7564062451308002, props: { number: '486' } },
            { location: 3.676451488740472, props: { number: '487' } },
            { location: 3.6051875030897884, props: { number: '491' } },
            { location: 1.4323857514944933, props: { number: '505' } },
            { location: 3.5463630583089762, props: { number: '505' } },
            { location: 3.481033501595358, props: { number: '511' } },
            { location: 3.4352946378548346, props: { number: '520' } },
            { location: 3.376199346381432, props: { number: '524' } },
            { location: 3.4286838275546687, props: { number: '525' } },
            { location: 3.339307489851471, props: { number: '528' } },
            { location: 3.3411749431790114, props: { number: '532' } },
            { location: 3.336703072698376, props: { number: '535' } },
            { location: 3.058288319324677, props: { number: '545' } },
            { location: 3.1033531945017234, props: { number: '546' } },
            { location: 1.6205519160625252, props: { number: '555' } },
            { location: 1.5975109648265906, props: { number: '555' } },
            { location: 3.0253719850114096, props: { number: '555' } },
            { location: 2.9994544031082873, props: { number: '556' } },
            { location: 2.979710448236514, props: { number: '559' } },
            { location: 2.955203156702287, props: { number: '560' } },
            { location: 2.942475891917175, props: { number: '563' } },
            { location: 2.8884832598048957, props: { number: '567' } },
            { location: 1.6544211797370654, props: { number: '575' } },
            { location: 1.7256312707853605, props: { number: '595' } },
            { location: 1.8235482137266013, props: { number: '655' } }
        ]
    };

    cluster.addressPoints.sort((a, b) => a.location - b.location);

    const distDelta = buildDistDelta(cluster);

    const breaks = [];

    Cluster.detectCliffs(breaks, cluster.addressPoints, distDelta);

    t.deepEquals(breaks, [30, 39]);
    t.end();
});
